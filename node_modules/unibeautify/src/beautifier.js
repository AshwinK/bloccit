"use strict";
/// <reference path="../typings/modules/bluebird/index.d.ts" />

var _slicedToArray = function () { function sliceIterator(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"]) _i["return"](); } finally { if (_d) throw _e; } } return _arr; } return function (arr, i) { if (Array.isArray(arr)) { return arr; } else if (Symbol.iterator in Object(arr)) { return sliceIterator(arr, i); } else { throw new TypeError("Invalid attempt to destructure non-iterable instance"); } }; }();

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol ? "symbol" : typeof obj; };

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var Promise = require("bluebird");
var _ = require("lodash");
;
;
/**
Beautifier
*/

var Unibeautify = function () {
    function Unibeautify() {
        _classCallCheck(this, Unibeautify);

        /**
               */
        this.options = {};
        /**
               */
        this.languages = [];
        /**
               */
        this.beautifiers = [];
    }
    /**
    Get a copy of the languages currently loaded.
    */


    _createClass(Unibeautify, [{
        key: "getLoadedLanguages",
        value: function getLoadedLanguages() {
            return this.languages.slice();
        }
        /**
        Load Options
        */

    }, {
        key: "loadOptions",
        value: function loadOptions(options) {
            _.merge(this.options, options);
            return this;
        }
        /**
        Load a Language
        */

    }, {
        key: "loadLanguage",
        value: function loadLanguage(language) {
            this.languages.push(language);
            return this;
        }
        /**
        Load multiple Languages
        */

    }, {
        key: "loadLanguages",
        value: function loadLanguages(languages) {
            var _languages;

            (_languages = this.languages).push.apply(_languages, _toConsumableArray(languages));
            return this;
        }
        /**
        Load a Beautifier
        */

    }, {
        key: "loadBeautifier",
        value: function loadBeautifier(beautifier) {
            this.beautifiers.push(beautifier);
            return this;
        }
        /**
        Load multiple beautifiers.
        */

    }, {
        key: "loadBeautifiers",
        value: function loadBeautifiers(beautifiers) {
            var _beautifiers;

            (_beautifiers = this.beautifiers).push.apply(_beautifiers, _toConsumableArray(beautifiers));
            return this;
        }
        /**
        Find and return the appropriate Language for the given file extension.
        */

    }, {
        key: "findLanguagesForExtension",
        value: function findLanguagesForExtension(extension) {
            return this.findLanguages({
                extension: extension
            });
        }
        /**
        Find and return the appropriate Languages that match any of the given filter criteria.
        An empty array will be returned if there are no matches.
           Precedence:
        - name
        - namespace
        - extension
        - atomGrammar
        - sublimeSyntax
        */

    }, {
        key: "findLanguages",
        value: function findLanguages(query) {
            var langs = [];
            // Name
            langs.push(_.filter(this.languages, function (c) {
                return _.isEqual(c.name, query.name);
            }));
            // Namespace
            langs.push(_.filter(this.languages, function (c) {
                return _.isEqual(c.namespace, query.namespace);
            }));
            // Extension
            langs.push(_.filter(this.languages, function (c) {
                return _.includes(c.extensions, query.extension);
            }));
            // Atom Grammar
            langs.push(_.filter(this.languages, function (c) {
                return _.includes(c.atomGrammars, query.atomGrammar);
            }));
            // Sublime Syntax
            langs.push(_.filter(this.languages, function (c) {
                return _.includes(c.sublimeSyntaxes, query.sublimeSyntax);
            }));
            // Return unique array of Languages
            return _.uniq(_.flatten(langs));
        }
        /**
        Find and return the appropriate Beautifiers for the given Language.
        */

    }, {
        key: "getBeautifiersForLanguage",
        value: function getBeautifiersForLanguage(language) {
            // TODO
            return _.filter(this.beautifiers, function (b) {
                return _.includes(Object.keys(b.options), language.name);
            });
        }
        /**
        Get default beautifier for given language and options.
        */

    }, {
        key: "getBeautifierForLanguage",
        value: function getBeautifierForLanguage(language, options) {
            // TODO
            var beautifiers = this.getBeautifiersForLanguage(language);
            if (beautifiers.length > 0) {
                return beautifiers[0];
            } else {
                return null;
            }
        }
        /**
        Extract the Language-specific option values.
        */

    }, {
        key: "beautify",

        /**
        Beautify code
        */
        value: function beautify(data) {
            // Get Language
            var langs = this.findLanguages({
                atomGrammar: data.atomGrammar,
                extension: data.fileExtension,
                name: data.languageName,
                sublimeSyntax: data.sublimeSyntax
            });
            var lang = langs.length > 0 ? langs[0] : null;
            if (lang == null) {
                return Promise.reject(new Error("Cannot find language."));
            }
            // Get Options for Language
            var langOptions = Unibeautify.getOptionsForLanguage(lang, data.options);
            // Get Beautifier
            var beautifier = this.getBeautifierForLanguage(lang, langOptions);
            // Run beautifier
            if (beautifier != null) {
                // Get Options for Beautifier
                var options = Unibeautify.getOptionsForBeautifier(beautifier, lang, langOptions);
                return beautifier.beautify({
                    filePath: data.fileExtension,
                    language: lang,
                    options: options,
                    Promise: Promise,
                    projectPath: data.projectPath,
                    text: data.text
                });
            } else {
                return Promise.reject(new Error("Beautifier not found for Language: " + lang.name));
            }
        }
    }], [{
        key: "getOptionsForLanguage",
        value: function getOptionsForLanguage(language, options) {
            var name = language.name;

            return options[name] || {};
        }
        /**
        Extract the option values that the Beautifier supports, including applying transformations.
        */

    }, {
        key: "getOptionsForBeautifier",
        value: function getOptionsForBeautifier(beautifier, language, options) {
            var globalOptions = beautifier.options["_"];
            var beautifierOptions = beautifier.options[language.name];
            // Global options
            if ((typeof globalOptions === "undefined" ? "undefined" : _typeof(globalOptions)) === "object") {
                if (beautifierOptions === true) {
                    beautifierOptions = globalOptions;
                } else if ((typeof beautifierOptions === "undefined" ? "undefined" : _typeof(beautifierOptions)) === "object") {
                    beautifierOptions = Object.assign({}, globalOptions, beautifierOptions);
                }
            }
            // Transform options
            if (typeof beautifierOptions === "boolean") {
                if (beautifierOptions === true) {
                    return options;
                } else {
                    return {};
                }
            } else if ((typeof beautifierOptions === "undefined" ? "undefined" : _typeof(beautifierOptions)) === "object") {
                var transformedOptions = {};
                for (var field in beautifierOptions) {
                    var op = beautifierOptions[field];
                    if (typeof op === "string") {
                        transformedOptions[field] = options[op];
                    } else if (typeof op === "function") {
                        transformedOptions[field] = op(options[field]);
                    } else if (typeof op === "boolean") {
                        if (op === true) {
                            transformedOptions[field] = options[field];
                        }
                    } else if (_.isArray(op)) {
                        var _op = _slicedToArray(op, 2);

                        var fields = _op[0];
                        var fn = _op[1];

                        var vals = _.map(fields, function (f) {
                            return options[f];
                        });
                        var obj = _.zipObject(fields, vals);
                        transformedOptions[field] = fn(obj);
                    }
                }
                return transformedOptions;
            } else {
                return options;
            }
        }
    }]);

    return Unibeautify;
}();

exports.Unibeautify = Unibeautify;
//# sourceMappingURL=beautifier.js.map
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImJlYXV0aWZpZXIuanMiXSwibmFtZXMiOlsiUHJvbWlzZSIsInJlcXVpcmUiLCJfIiwiVW5pYmVhdXRpZnkiLCJvcHRpb25zIiwibGFuZ3VhZ2VzIiwiYmVhdXRpZmllcnMiLCJzbGljZSIsIm1lcmdlIiwibGFuZ3VhZ2UiLCJwdXNoIiwiYmVhdXRpZmllciIsImV4dGVuc2lvbiIsImZpbmRMYW5ndWFnZXMiLCJxdWVyeSIsImxhbmdzIiwiZmlsdGVyIiwiYyIsImlzRXF1YWwiLCJuYW1lIiwibmFtZXNwYWNlIiwiaW5jbHVkZXMiLCJleHRlbnNpb25zIiwiYXRvbUdyYW1tYXJzIiwiYXRvbUdyYW1tYXIiLCJzdWJsaW1lU3ludGF4ZXMiLCJzdWJsaW1lU3ludGF4IiwidW5pcSIsImZsYXR0ZW4iLCJiIiwiT2JqZWN0Iiwia2V5cyIsImdldEJlYXV0aWZpZXJzRm9yTGFuZ3VhZ2UiLCJsZW5ndGgiLCJkYXRhIiwiZmlsZUV4dGVuc2lvbiIsImxhbmd1YWdlTmFtZSIsImxhbmciLCJyZWplY3QiLCJFcnJvciIsImxhbmdPcHRpb25zIiwiZ2V0T3B0aW9uc0Zvckxhbmd1YWdlIiwiZ2V0QmVhdXRpZmllckZvckxhbmd1YWdlIiwiZ2V0T3B0aW9uc0ZvckJlYXV0aWZpZXIiLCJiZWF1dGlmeSIsImZpbGVQYXRoIiwicHJvamVjdFBhdGgiLCJ0ZXh0IiwiZ2xvYmFsT3B0aW9ucyIsImJlYXV0aWZpZXJPcHRpb25zIiwiYXNzaWduIiwidHJhbnNmb3JtZWRPcHRpb25zIiwiZmllbGQiLCJvcCIsImlzQXJyYXkiLCJmaWVsZHMiLCJmbiIsInZhbHMiLCJtYXAiLCJmIiwib2JqIiwiemlwT2JqZWN0IiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTs7Ozs7Ozs7Ozs7O0FBQ0EsSUFBTUEsVUFBVUMsUUFBUSxVQUFSLENBQWhCO0FBQ0EsSUFBTUMsSUFBSUQsUUFBUSxRQUFSLENBQVY7QUFDQTtBQUNBO0FBQ0E7Ozs7SUFHTUUsVztBQUNGLDJCQUFjO0FB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dGlmaWVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG4vLy8gPHJlZmVyZW5jZSBwYXRoPVwiLi4vdHlwaW5ncy9tb2R1bGVzL2JsdWViaXJkL2luZGV4LmQudHNcIiAvPlxuY29uc3QgUHJvbWlzZSA9IHJlcXVpcmUoXCJibHVlYmlyZFwiKTtcbmNvbnN0IF8gPSByZXF1aXJlKFwibG9kYXNoXCIpO1xuO1xuO1xuLyoqXG5CZWF1dGlmaWVyXG4qL1xuY2xhc3MgVW5pYmVhdXRpZnkge1xuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICAvKipcbiAgICAgIFxuICAgICAgICAqL1xuICAgICAgICB0aGlzLm9wdGlvbnMgPSB7fTtcbiAgICAgICAgLyoqXG4gICAgICBcbiAgICAgICAgKi9cbiAgICAgICAgdGhpcy5sYW5ndWFnZXMgPSBbXTtcbiAgICAgICAgLyoqXG4gICAgICBcbiAgICAgICAgKi9cbiAgICAgICAgdGhpcy5iZWF1dGlmaWVycyA9IFtdO1xuICAgIH1cbiAgICAvKipcbiAgICBHZXQgYSBjb3B5IG9mIHRoZSBsYW5ndWFnZXMgY3VycmVudGx5IGxvYWRlZC5cbiAgICAqL1xuICAgIGdldExvYWRlZExhbmd1YWdlcygpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubGFuZ3VhZ2VzLnNsaWNlKCk7XG4gICAgfVxuICAgIC8qKlxuICAgIExvYWQgT3B0aW9uc1xuICAgICovXG4gICAgbG9hZE9wdGlvbnMob3B0aW9ucykge1xuICAgICAgICBfLm1lcmdlKHRoaXMub3B0aW9ucywgb3B0aW9ucyk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cbiAgICAvKipcbiAgICBMb2FkIGEgTGFuZ3VhZ2VcbiAgICAqL1xuICAgIGxvYWRMYW5ndWFnZShsYW5ndWFnZSkge1xuICAgICAgICB0aGlzLmxhbmd1YWdlcy5wdXNoKGxhbmd1YWdlKTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuICAgIC8qKlxuICAgIExvYWQgbXVsdGlwbGUgTGFuZ3VhZ2VzXG4gICAgKi9cbiAgICBsb2FkTGFuZ3VhZ2VzKGxhbmd1YWdlcykge1xuICAgICAgICB0aGlzLmxhbmd1YWdlcy5wdXNoKC4uLmxhbmd1YWdlcyk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cbiAgICAvKipcbiAgICBMb2FkIGEgQmVhdXRpZmllclxuICAgICovXG4gICAgbG9hZEJlYXV0aWZpZXIoYmVhdXRpZmllcikge1xuICAgICAgICB0aGlzLmJlYXV0aWZpZXJzLnB1c2goYmVhdXRpZmllcik7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cbiAgICAvKipcbiAgICBMb2FkIG11bHRpcGxlIGJlYXV0aWZpZXJzLlxuICAgICovXG4gICAgbG9hZEJlYXV0aWZpZXJzKGJlYXV0aWZpZXJzKSB7XG4gICAgICAgIHRoaXMuYmVhdXRpZmllcnMucHVzaCguLi5iZWF1dGlmaWVycyk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cbiAgICAvKipcbiAgICBGaW5kIGFuZCByZXR1cm4gdGhlIGFwcHJvcHJpYXRlIExhbmd1YWdlIGZvciB0aGUgZ2l2ZW4gZmlsZSBleHRlbnNpb24uXG4gICAgKi9cbiAgICBmaW5kTGFuZ3VhZ2VzRm9yRXh0ZW5zaW9uKGV4dGVuc2lvbikge1xuICAgICAgICByZXR1cm4gdGhpcy5maW5kTGFuZ3VhZ2VzKHtcbiAgICAgICAgICAgIGV4dGVuc2lvblxuICAgICAgICB9KTtcbiAgICB9XG4gICAgLyoqXG4gICAgRmluZCBhbmQgcmV0dXJuIHRoZSBhcHByb3ByaWF0ZSBMYW5ndWFnZXMgdGhhdCBtYXRjaCBhbnkgb2YgdGhlIGdpdmVuIGZpbHRlciBjcml0ZXJpYS5cbiAgICBBbiBlbXB0eSBhcnJheSB3aWxsIGJlIHJldHVybmVkIGlmIHRoZXJlIGFyZSBubyBtYXRjaGVzLlxuICBcbiAgICBQcmVjZWRlbmNlOlxuICAgIC0gbmFtZVxuICAgIC0gbmFtZXNwYWNlXG4gICAgLSBleHRlbnNpb25cbiAgICAtIGF0b21HcmFtbWFyXG4gICAgLSBzdWJsaW1lU3ludGF4XG4gICAgKi9cbiAgICBmaW5kTGFuZ3VhZ2VzKHF1ZXJ5KSB7XG4gICAgICAgIGNvbnN0IGxhbmdzID0gW107XG4gICAgICAgIC8vIE5hbWVcbiAgICAgICAgbGFuZ3MucHVzaChfLmZpbHRlcih0aGlzLmxhbmd1YWdlcywgKGMpID0+IF8uaXNFcXVhbChjLm5hbWUsIHF1ZXJ5Lm5hbWUpKSk7XG4gICAgICAgIC8vIE5hbWVzcGFjZVxuICAgICAgICBsYW5ncy5wdXNoKF8uZmlsdGVyKHRoaXMubGFuZ3VhZ2VzLCAoYykgPT4gXy5pc0VxdWFsKGMubmFtZXNwYWNlLCBxdWVyeS5uYW1lc3BhY2UpKSk7XG4gICAgICAgIC8vIEV4dGVuc2lvblxuICAgICAgICBsYW5ncy5wdXNoKF8uZmlsdGVyKHRoaXMubGFuZ3VhZ2VzLCAoYykgPT4gXy5pbmNsdWRlcyhjLmV4dGVuc2lvbnMsIHF1ZXJ5LmV4dGVuc2lvbikpKTtcbiAgICAgICAgLy8gQXRvbSBHcmFtbWFyXG4gICAgICAgIGxhbmdzLnB1c2goXy5maWx0ZXIodGhpcy5sYW5ndWFnZXMsIChjKSA9PiBfLmluY2x1ZGVzKGMuYXRvbUdyYW1tYXJzLCBxdWVyeS5hdG9tR3JhbW1hcikpKTtcbiAgICAgICAgLy8gU3VibGltZSBTeW50YXhcbiAgICAgICAgbGFuZ3MucHVzaChfLmZpbHRlcih0aGlzLmxhbmd1YWdlcywgKGMpID0+IF8uaW5jbHVkZXMoYy5zdWJsaW1lU3ludGF4ZXMsIHF1ZXJ5LnN1YmxpbWVTeW50YXgpKSk7XG4gICAgICAgIC8vIFJldHVybiB1bmlxdWUgYXJyYXkgb2YgTGFuZ3VhZ2VzXG4gICAgICAgIHJldHVybiBfLnVuaXEoXy5mbGF0dGVuKGxhbmdzKSk7XG4gICAgfVxuICAgIC8qKlxuICAgIEZpbmQgYW5kIHJldHVybiB0aGUgYXBwcm9wcmlhdGUgQmVhdXRpZmllcnMgZm9yIHRoZSBnaXZlbiBMYW5ndWFnZS5cbiAgICAqL1xuICAgIGdldEJlYXV0aWZpZXJzRm9yTGFuZ3VhZ2UobGFuZ3VhZ2UpIHtcbiAgICAgICAgLy8gVE9ET1xuICAgICAgICByZXR1cm4gXy5maWx0ZXIodGhpcy5iZWF1dGlmaWVycywgKGIpID0+IF8uaW5jbHVkZXMoT2JqZWN0LmtleXMoYi5vcHRpb25zKSwgbGFuZ3VhZ2UubmFtZSkpO1xuICAgIH1cbiAgICAvKipcbiAgICBHZXQgZGVmYXVsdCBiZWF1dGlmaWVyIGZvciBnaXZlbiBsYW5ndWFnZSBhbmQgb3B0aW9ucy5cbiAgICAqL1xuICAgIGdldEJlYXV0aWZpZXJGb3JMYW5ndWFnZShsYW5ndWFnZSwgb3B0aW9ucykge1xuICAgICAgICAvLyBUT0RPXG4gICAgICAgIGNvbnN0IGJlYXV0aWZpZXJzID0gdGhpcy5nZXRCZWF1dGlmaWVyc0Zvckxhbmd1YWdlKGxhbmd1YWdlKTtcbiAgICAgICAgaWYgKGJlYXV0aWZpZXJzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIHJldHVybiBiZWF1dGlmaWVyc1swXTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgfVxuICAgIC8qKlxuICAgIEV4dHJhY3QgdGhlIExhbmd1YWdlLXNwZWNpZmljIG9wdGlvbiB2YWx1ZXMuXG4gICAgKi9cbiAgICBzdGF0aWMgZ2V0T3B0aW9uc0Zvckxhbmd1YWdlKGxhbmd1YWdlLCBvcHRpb25zKSB7XG4gICAgICAgIGNvbnN0IHsgbmFtZSB9ID0gbGFuZ3VhZ2U7XG4gICAgICAgIHJldHVybiBvcHRpb25zW25hbWVdIHx8IHt9O1xuICAgIH1cbiAgICAvKipcbiAgICBFeHRyYWN0IHRoZSBvcHRpb24gdmFsdWVzIHRoYXQgdGhlIEJlYXV0aWZpZXIgc3VwcG9ydHMsIGluY2x1ZGluZyBhcHBseWluZyB0cmFuc2Zvcm1hdGlvbnMuXG4gICAgKi9cbiAgICBzdGF0aWMgZ2V0T3B0aW9uc0ZvckJlYXV0aWZpZXIoYmVhdXRpZmllciwgbGFuZ3VhZ2UsIG9wdGlvbnMpIHtcbiAgICAgICAgY29uc3QgZ2xvYmFsT3B0aW9ucyA9IGJlYXV0aWZpZXIub3B0aW9uc1tcIl9cIl07XG4gICAgICAgIGxldCBiZWF1dGlmaWVyT3B0aW9ucyA9IGJlYXV0aWZpZXIub3B0aW9uc1tsYW5ndWFnZS5uYW1lXTtcbiAgICAgICAgLy8gR2xvYmFsIG9wdGlvbnNcbiAgICAgICAgaWYgKHR5cGVvZiBnbG9iYWxPcHRpb25zID09PSBcIm9iamVjdFwiKSB7XG4gICAgICAgICAgICBpZiAoYmVhdXRpZmllck9wdGlvbnMgPT09IHRydWUpIHtcbiAgICAgICAgICAgICAgICBiZWF1dGlmaWVyT3B0aW9ucyA9IGdsb2JhbE9wdGlvbnM7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmICh0eXBlb2YgYmVhdXRpZmllck9wdGlvbnMgPT09IFwib2JqZWN0XCIpIHtcbiAgICAgICAgICAgICAgICBiZWF1dGlmaWVyT3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe30sIGdsb2JhbE9wdGlvbnMsIGJlYXV0aWZpZXJPcHRpb25zKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICAvLyBUcmFuc2Zvcm0gb3B0aW9uc1xuICAgICAgICBpZiAodHlwZW9mIGJlYXV0aWZpZXJPcHRpb25zID09PSBcImJvb2xlYW5cIikge1xuICAgICAgICAgICAgaWYgKGJlYXV0aWZpZXJPcHRpb25zID09PSB0cnVlKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG9wdGlvbnM7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4ge307XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAodHlwZW9mIGJlYXV0aWZpZXJPcHRpb25zID09PSBcIm9iamVjdFwiKSB7XG4gICAgICAgICAgICBjb25zdCB0cmFuc2Zvcm1lZE9wdGlvbnMgPSB7fTtcbiAgICAgICAgICAgIGZvciAobGV0IGZpZWxkIGluIGJlYXV0aWZpZXJPcHRpb25zKSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgb3AgPSBiZWF1dGlmaWVyT3B0aW9uc1tmaWVsZF07XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvcCA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgICAgICAgICAgICAgICB0cmFuc2Zvcm1lZE9wdGlvbnNbZmllbGRdID0gb3B0aW9uc1tvcF07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKHR5cGVvZiBvcCA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgICAgICAgICAgICAgIHRyYW5zZm9ybWVkT3B0aW9uc1tmaWVsZF0gPSBvcChvcHRpb25zW2ZpZWxkXSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKHR5cGVvZiBvcCA9PT0gXCJib29sZWFuXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG9wID09PSB0cnVlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2Zvcm1lZE9wdGlvbnNbZmllbGRdID0gb3B0aW9uc1tmaWVsZF07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAoXy5pc0FycmF5KG9wKSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBbZmllbGRzLCBmbl0gPSBvcDtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdmFscyA9IF8ubWFwKGZpZWxkcywgZnVuY3Rpb24gKGYpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvcHRpb25zW2ZdO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb2JqID0gXy56aXBPYmplY3QoZmllbGRzLCB2YWxzKTtcbiAgICAgICAgICAgICAgICAgICAgdHJhbnNmb3JtZWRPcHRpb25zW2ZpZWxkXSA9IGZuKG9iaik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHRyYW5zZm9ybWVkT3B0aW9ucztcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBvcHRpb25zO1xuICAgICAgICB9XG4gICAgfVxuICAgIC8qKlxuICAgIEJlYXV0aWZ5IGNvZGVcbiAgICAqL1xuICAgIGJlYXV0aWZ5KGRhdGEpIHtcbiAgICAgICAgLy8gR2V0IExhbmd1YWdlXG4gICAgICAgIGNvbnN0IGxhbmdzID0gdGhpcy5maW5kTGFuZ3VhZ2VzKHtcbiAgICAgICAgICAgIGF0b21HcmFtbWFyOiBkYXRhLmF0b21HcmFtbWFyLFxuICAgICAgICAgICAgZXh0ZW5zaW9uOiBkYXRhLmZpbGVFeHRlbnNpb24sXG4gICAgICAgICAgICBuYW1lOiBkYXRhLmxhbmd1YWdlTmFtZSxcbiAgICAgICAgICAgIHN1YmxpbWVTeW50YXg6IGRhdGEuc3VibGltZVN5bnRheCxcbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IGxhbmcgPSBsYW5ncy5sZW5ndGggPiAwID8gbGFuZ3NbMF0gOiBudWxsO1xuICAgICAgICBpZiAobGFuZyA9PSBudWxsKSB7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKFwiQ2Fubm90IGZpbmQgbGFuZ3VhZ2UuXCIpKTtcbiAgICAgICAgfVxuICAgICAgICAvLyBHZXQgT3B0aW9ucyBmb3IgTGFuZ3VhZ2VcbiAgICAgICAgY29uc3QgbGFuZ09wdGlvbnMgPSBVbmliZWF1dGlmeS5nZXRPcHRpb25zRm9yTGFuZ3VhZ2UobGFuZywgZGF0YS5vcHRpb25zKTtcbiAgICAgICAgLy8gR2V0IEJlYXV0aWZpZXJcbiAgICAgICAgY29uc3QgYmVhdXRpZmllciA9IHRoaXMuZ2V0QmVhdXRpZmllckZvckxhbmd1YWdlKGxhbmcsIGxhbmdPcHRpb25zKTtcbiAgICAgICAgLy8gUnVuIGJlYXV0aWZpZXJcbiAgICAgICAgaWYgKGJlYXV0aWZpZXIgIT0gbnVsbCkge1xuICAgICAgICAgICAgLy8gR2V0IE9wdGlvbnMgZm9yIEJlYXV0aWZpZXJcbiAgICAgICAgICAgIGNvbnN0IG9wdGlvbnMgPSBVbmliZWF1dGlmeS5nZXRPcHRpb25zRm9yQmVhdXRpZmllcihiZWF1dGlmaWVyLCBsYW5nLCBsYW5nT3B0aW9ucyk7XG4gICAgICAgICAgICByZXR1cm4gYmVhdXRpZmllci5iZWF1dGlmeSh7XG4gICAgICAgICAgICAgICAgZmlsZVBhdGg6IGRhdGEuZmlsZUV4dGVuc2lvbixcbiAgICAgICAgICAgICAgICBsYW5ndWFnZTogbGFuZyxcbiAgICAgICAgICAgICAgICBvcHRpb25zLFxuICAgICAgICAgICAgICAgIFByb21pc2UsXG4gICAgICAgICAgICAgICAgcHJvamVjdFBhdGg6IGRhdGEucHJvamVjdFBhdGgsXG4gICAgICAgICAgICAgICAgdGV4dDogZGF0YS50ZXh0LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKGBCZWF1dGlmaWVyIG5vdCBmb3VuZCBmb3IgTGFuZ3VhZ2U6ICR7bGFuZy5uYW1lfWApKTtcbiAgICAgICAgfVxuICAgIH1cbn1cbmV4cG9ydHMuVW5pYmVhdXRpZnkgPSBVbmliZWF1dGlmeTtcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPWJlYXV0aWZpZXIuanMubWFwIl19